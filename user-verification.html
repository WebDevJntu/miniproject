<body>
    <div id="result" style="display:none">
        
    <h3><a id="continueURL" href="">CLICK HERE TO REDIRECT TO LOGIN PAGE</a></h3>
    </div>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
    <script>
        function searchAndReplace(oldStr, newStr)
        {
            while(continueURL.search(oldStr)!=-1)
                continueURL = continueURL.replace(oldStr, newStr);
        }
    document.addEventListener('DOMContentLoaded', function() 
    {
      var queryString = window.location.search;
	  queryString = queryString.substring(1);
       
      var parsedQueryString = getQueryString(queryString);
      // Get the action to complete.
      var mode = parsedQueryString['mode'];
       
      // Get the one-time code from the query parameter.
      var actionCode = parsedQueryString['oobCode'];
       
      // (Optional) Get the API key from the query parameter.
      var apiKey = parsedQueryString['apiKey'];
      continueURL = parsedQueryString['continueUrl'];
      searchAndReplace("%3F", "?");
      searchAndReplace("%3A", ":");
      searchAndReplace("%2F", "/");
      searchAndReplace("%3D", "=");
      searchAndReplace("%40", "@");
      searchAndReplace("%26", "&");
               // alert(continueURL);
        
      queryString = continueURL;
	  queryString = queryString.split('?');
      continueURL = queryString[1];
        
        var parsedURL = getQueryString(continueURL);
         email = parsedURL['email'];
         uname = parsedURL['username'];
         uid = parsedURL['uid'];
         //alert("email="+email+"||uname="+uname+"||uid="+uid);
      var config = 
      {
        apiKey: apiKey,
        authDomain: "vishnu-a7bac.firebaseapp.com",
	    databaseURL: "https://vishnu-a7bac.firebaseio.com",
	    projectId: "vishnu-a7bac",
	    storageBucket: "vishnu-a7bac.appspot.com",
	    messagingSenderId: "43664081987"
      };
      var app = firebase.initializeApp(config);
      var auth = app.auth();

      // Handle the user management action.
      switch (mode) {
        case 'verifyEmail':
          // Display email verification handler and UI.
          handleVerifyEmail(auth, actionCode);
          break;
        default:
          // Error: invalid mode.
      }
    }, false);
        
    function handleVerifyEmail(auth, actionCode) {
      // Try to apply the email verification code.
      auth.applyActionCode(actionCode).then(function(resp) 
	  {
        firebase.firestore().collection("users").doc().set({email:email,uid:uid,uname:uname,verified:true}).then(function(){
              
              document.getElementById("result").style.display = "block";
              document.getElementById("continueURL").href = "index.html";
          });
      }).catch(function(error) {
        // Code is invalid or expired. Ask the user to verify their email address
        // again.
          alert(error.code+"/"+error.message+"/"+error.name);
      });
    }

	function getQueryString( queryString ) 
	{
		
            var params = {}, queries, temp, i, l;
            // Split into key/value pairs
            queries = queryString.split("&");
            // Convert the array of strings into an object
            for ( i = 0, l = queries.length; i < l; i++ ) {
                temp = queries[i].split('=');
                params[temp[0]] = temp[1];
                //alert(temp[0]+"||"+temp[1]);
            }
            return params;
    }
    </script>
</body>