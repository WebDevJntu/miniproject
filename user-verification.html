<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/loginStyle.css">
</head>
<body>
    <div id="result" style="display:none">
    <h3><a id="continueURL" href="">CLICK HERE TO REDIRECT TO LOGIN PAGE</a></h3>
    </div>
    <div id="app-result" style="display:none"></div>
    <div id="reset" style="display: none">
        <table class="table" align="center">
            <tr>
                <td><input type="password" class="textfield" id="newpass" placeholder="Enter new password here"></td>
            </tr>
            <tr>
                <td><input type="password" class="textfield" id="confirmpass" placeholder="Re-enter new password"></td>
            </tr>
            <tr>
                <td><button id="reset-pass" class="button button1">Update Password</button></td>
            </tr>
        </table>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
    
    <script>
        
    function searchAndReplace(oldStr, newStr)
    {
        while(continueURL.search(oldStr)!=-1)
            continueURL = continueURL.replace(oldStr, newStr);
    }
        
    document.addEventListener('DOMContentLoaded', function() 
    {
        
      vflag = 0;
      var queryString = window.location.search;
      queryString = queryString.substring(1);
      var parsedQueryString = getQueryString(queryString);
      var mode = parsedQueryString['mode'];
      actionCode = parsedQueryString['oobCode'];
      apiKey = parsedQueryString['apiKey'];
        
        if(mode == 'verifyEmail')
        {
          continueURL = parsedQueryString['continueUrl'];
          if(continueURL!=null && continueURL!=" ")
          {
              vflag = 1;
              searchAndReplace("%3F", "?");
              searchAndReplace("%3A", ":");
              searchAndReplace("%2F", "/");
              searchAndReplace("%3D", "=");
              searchAndReplace("%40", "@");
              searchAndReplace("%26", "&");
                       

              queryString = continueURL;
              queryString = queryString.split('?');

              continueURL = queryString[1];
              parsedURL = getQueryString(continueURL);
              email = parsedURL['email'];
              uname = parsedURL['username'];
              uid = parsedURL['uid'];
          }
        }
        
      var config=
      {
          apiKey: apiKey,
          authDomain: "placement-8880e.firebaseapp.com",
          databaseURL: "https://placement-8880e.firebaseio.com",
          projectId: "placement-8880e",
          storageBucket: "placement-8880e.appspot.com",
          messagingSenderId: "471023664325"
          
      };
      app = firebase.initializeApp(config);
      auth = app.auth();

      
      switch (mode) 
      {
        case 'verifyEmail': handleVerifyEmail(auth, actionCode);
                            break;
        case 'resetPassword': handleResetPassword(auth, actionCode);
                              break;
        default:
          
      }
        
    }, false);  //DOMLISTENER END;
    
        
    function handleVerifyEmail(auth, actionCode) 
    {
      
          auth.applyActionCode(actionCode).then(function(resp) 
          {
            if(vflag==1)
            {
                firebase.firestore().collection("users").doc().set({email:email,uid:uid,uname:uname,verified:true}).then(function(){

                      document.getElementById("result").style.display = "block";
                      document.getElementById("continueURL").href = "index.html";
            
              });
            }
            else{
                document.getElementById("app-result").style.display = "block";
                var msg  = "You have been verified.Please go to app";
                document.getElementById("app-result").innerHTML = msg;
            }
          }).catch(function(error) {
              alert(error.code+"/"+error.message+"/"+error.name);
          });
      
    }

    function handleResetPassword(auth, actionCode)
    {
        var accountEmail;
        var flag = 0;
        auth.verifyPasswordResetCode(actionCode).then(function(email) {
        var accountEmail = email;
        document.getElementById("reset").style.display="block";
        document.getElementById("reset-pass").addEventListener('click', updatePassword);
          
      }).catch(function(error) {
            alert(error.code+"/"+error.message+"/"+error.name);
      });
    }
        
    function updatePassword()
    {
        var newpass = document.getElementById("newpass").value.trim();
          var confirmpass = document.getElementById("confirmpass").value.trim();
          flag = 0;
          if(newpass != confirmpass)
          {
              alert("Please enter same password in both the fields");
              flag = 1;
          }

          if(flag == 0)
              {
                auth.confirmPasswordReset(actionCode, newpass).then(function(resp) 
                {
                    alert("Password updated successfully");
                    document.getElementById("result").style.display = "block";
                    document.getElementById("reset").style.display = "none";
                    document.getElementById("continueURL").href = "index.html";

                }).catch(function(error) {
                    alert(error.code+"/"+error.message+"/"+error.name);
                });
              }
    }
        
	function getQueryString( queryString ) 
	{
		
            var params = {}, queries, temp, i, l;
            queries = queryString.split("&");
            for ( i = 0, l = queries.length; i < l; i++ ) 
            {
                temp = queries[i].split('=');
                params[temp[0]] = temp[1];
    
            }
            return params;
    }
        
    </script>
</body>
</html>